<?php


namespace DDDGen\Tests;


use DDDGen\Generator;
use DDDGen\VO\FQCN;
use DDDGen\VO\Layer;
use DDDGen\VO\Primitive;
use PHPUnit\Framework\TestCase;

class GeneratorTest extends TestCase
{
    protected function tearDown()
    {
        parent::tearDown(); // TODO: Change the autogenerated stub
        
        // remove all tmp folders
        passthru("rm -rf " . __DIR__ . "/resources/tmp");
    }
    
    
    function test_it_accepts_config()
    {
        [$config, $primitives, $generator] = $this->seed_config();
        
        
        // Make API call
        $layer          = "app";
        $primitive_name = "command";
        $name           = "Some/Command/ClassName";
        
        $output = $generator->generate($layer, $primitive_name, FQCN::fromString($name));
        
        $this->assertEquals([
                                $config['src_dir'] . "/" . $layer . "/Some/Command/ClassName/ClassNameCommand.php" => __DIR__ . "/resources/stubs/SimpleStub.stub.php",
                                $config['src_dir'] . "/" . $layer . "/Some/Command/ClassName/ClassNameHandler.php" => __DIR__ . "/resources/stubs/SimpleStub.stub.php",
                                $config['test_dir'] . "/" . $layer . "/Some/Command/ClassName/ClassNameCommandTest.php" => __DIR__ . "/resources/stubs/SimpleTestStub.stub.php",
                            ], $output);
        
        foreach($output as $file => $stub) {
            $this->assertFileExists($file);
        }
        
    }
    
    private function seed_config()
    {
        $config = [
            "test_dir" => __DIR__ . "/resources/tmp/tests",
            "base_test_qcn" => "\\App\\Tests",
            "src_dir" => __DIR__ . "/resources/tmp/src",
            "layers" => [
                "app" => [
                    "base_qcn" => "\\DDDGenApp",
                    "dir" => "app",
                ],
                "domain" => [
                    "base_qcn" => "\\DDDGen",
                    "dir" => "domain",
                ],
                "infrastructure" => [
                    "base_qcn" => "\\DDDGenInfrastructure",
                    "dir" => "infrastructure",
                ],
            ],
            "primitives" => [
                "command" => [
                    "src" => [
                        "stubs" => [
                            "/*<PSR4_NAMESPACE_LAST>*/Command" => __DIR__ . "/resources/stubs/SimpleStub.stub.php",
                            "/*<PSR4_NAMESPACE_LAST>*/Handler.php" => __DIR__ . "/resources/stubs/SimpleStub.stub.php",
                        ],
                    ],
                    "test" => [
                        "stubs" => [
                            "/*<PSR4_NAMESPACE_LAST>*/CommandTest" => __DIR__ . "/resources/stubs/SimpleTestStub.stub.php",
                        ],
                    ],
                
                ],
            ],
        
        ];
        
        // make folders
        @mkdir($config['test_dir'], 0777, true);
        @mkdir($config['src_dir'], 0777, true);
        
        // instantiate objects
        
        $primitives = $this->makePrimitives($config['primitives']);
        $layers     = $this->makeLayers($config['layers']);
        
        $generator = new Generator(
            $config['src_dir'],
            $config['test_dir'],
            new FQCN($config['base_test_qcn']),
            $layers,
            $primitives
        );
        
        return [$config, $primitives, $generator];
    }
    
    private function makeLayers(array $config): array
    {
        $layers = [];
        foreach($config as $layer_name => $layer_config) {
            $layers[] = new Layer($layer_name, $layer_config['dir'], new FQCN($layer_config['base_qcn']));
        }
        
        return $layers;
    }
    
    private function makePrimitives(array $config): array
    {
        $primitives = [];
        foreach($config as $name => $primitive_config) {
            $primitives[] = new Primitive(
                $name,
                $primitive_config['src']['stubs'],
                $primitive_config['test']['stubs']
            );
        }
        
        return $primitives;
    }
    
}
